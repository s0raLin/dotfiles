# 撤销重做功能说明

## 新增功能

### 1. 撤销/重做历史管理
- **撤销历史**: 最多保存50个历史状态
- **重做历史**: 支持重做被撤销的操作
- **智能历史**: 每次内容变更自动保存到历史记录

### 2. 文件状态持久化 ⭐ 新增
- **跨文件状态保持**: 切换文件时保持每个文件的编辑状态
- **未保存更改提醒**: 切换文件时如有未保存更改会弹出确认对话框
- **状态恢复**: 切换回文件时自动恢复之前的编辑状态和撤销历史
- **页面刷新保护**: 浏览器关闭或刷新时提醒用户保存更改

### 3. 键盘快捷键
- **Ctrl+Z**: 撤销上一步操作
- **Ctrl+Shift+Z** 或 **Ctrl+Y**: 重做操作
- **Ctrl+S**: 保存文件到系统

### 4. 用户界面改进
- **撤销按钮**: 工具栏中的撤销图标，显示可撤销状态
- **重做按钮**: 工具栏中的重做图标，显示可重做状态
- **撤销所有更改**: 一键恢复到文件原始状态
- **状态栏显示**: 显示当前撤销/重做历史数量
- **文件列表状态**: 侧边栏文件名旁显示未保存更改标识(●)

### 5. 智能确认对话框 ⭐ 新增
- **切换文件确认**: 有未保存更改时显示确认对话框
- **三种选择**: 取消切换、丢弃更改、保存并切换
- **智能检测**: 自动检测所有文件的未保存状态

## 使用方法

### 基本操作
1. **编辑文件**: 在编辑器中修改内容，每次修改都会自动保存到撤销历史
2. **撤销操作**: 点击撤销按钮或按 Ctrl+Z
3. **重做操作**: 点击重做按钮或按 Ctrl+Shift+Z
4. **保存文件**: 点击保存按钮或按 Ctrl+S

### 文件切换流程 ⭐ 新增
1. **无更改切换**: 直接点击其他文件，立即切换
2. **有更改切换**: 点击其他文件时弹出确认对话框
   - **取消**: 继续编辑当前文件
   - **丢弃更改**: 放弃当前更改，切换到目标文件
   - **保存并切换**: 先保存当前文件，再切换到目标文件
3. **状态恢复**: 切换回之前编辑的文件时，自动恢复编辑状态

### 高级功能
- **撤销所有更改**: 点击"撤销所有更改"按钮，一键恢复到文件打开时的状态
- **查看历史状态**: 状态栏显示当前可撤销和可重做的操作数量
- **多文件状态**: 侧边栏显示所有文件的未保存状态

## 技术实现

### 状态管理
- 在 `AppContext` 中添加 `undoHistory` 和 `redoHistory` 数组
- 使用 `originalContent` 保存文件的原始内容
- 新增 `fileEditStates` 对象保存每个文件的编辑状态
- 实现 `UNDO`、`REDO`、`PUSH_TO_HISTORY`、`SAVE_FILE_STATE` 等 action

### 组件更新
- **SyntaxHighlightedEditor**: 添加键盘事件处理
- **Editor**: 集成撤销/重做按钮和全局快捷键，添加页面刷新保护
- **StatusBar**: 显示撤销/重做状态
- **Sidebar**: 显示文件未保存状态标识
- **UnsavedChangesDialog**: 新增确认对话框组件

### 状态持久化机制
- **保存时机**: 切换文件时自动保存当前文件的编辑状态
- **恢复时机**: 切换回文件时检查并恢复保存的编辑状态
- **清理时机**: 文件保存后清除对应的编辑状态
- **内存管理**: 避免无限制的状态累积

### 快捷键处理
- 编辑器内快捷键: 在 textarea 的 onKeyDown 事件中处理
- 全局快捷键: 在 Editor 组件中添加 document 事件监听
- 智能检测: 避免在其他输入元素中触发快捷键
- 页面保护: beforeunload 事件监听，防止意外丢失更改

## 注意事项

1. **历史记录限制**: 最多保存50个撤销状态，超出后自动删除最旧的记录
2. **内存管理**: 每个文件的编辑状态独立保存，文件保存后会清理对应状态
3. **保存行为**: 保存文件后会将当前内容设为新的原始内容，清空历史记录
4. **只读文件**: 系统文件等只读文件不支持撤销/重做功能
5. **页面刷新**: 刷新页面会丢失所有未保存的编辑状态
6. **确认对话框**: 切换文件时的确认对话框可以通过"取消"按钮关闭