# 撤销/重做功能修复

## 修复的问题

### 1. 撤销所有更改按钮需要点击两次
**问题原因：** `revertChanges` 方法调用了 `SET_ACTIVE_FILE` action，这会触发文件状态的重新设置，但没有正确清除历史记录。

**解决方案：** 
- 添加了新的 `REVERT_CHANGES` action 类型
- 直接设置内容为原始内容，并清除所有历史记录
- 避免了不必要的状态重置

### 2. 回退到最初状态时无法点击撤销所有更改按钮
**问题原因：** 按钮的禁用逻辑只检查 `isModified` 状态，没有考虑撤销历史的存在。

**解决方案：**
```tsx
// 修改前
disabled={!isModified || isLoading}

// 修改后  
disabled={(!isModified && undoHistory.length === 0) || isLoading}
```

现在按钮在以下情况下可以点击：
- 文件有修改 (`isModified === true`)
- 或者有撤销历史 (`undoHistory.length > 0`)

### 3. 状态指示器没有及时更新
**问题原因：** 
- `SET_FILE_CONTENT` action 中的 `isModified` 计算逻辑不够明确
- 保存文件时使用了 `SET_ACTIVE_FILE`，会重置历史记录

**解决方案：**
- 改进了 `SET_FILE_CONTENT` 中的状态计算逻辑
- 添加了 `SAVE_FILE_SUCCESS` action 来正确处理保存后的状态
- 确保状态更新能够正确传播到所有组件

## 技术改进

### 新增的 Action 类型
- `REVERT_CHANGES`: 专门处理撤销所有更改
- `SAVE_FILE_SUCCESS`: 专门处理文件保存成功后的状态更新

### 状态管理优化
- 更精确的状态计算逻辑
- 避免不必要的状态重置
- 确保状态一致性

## 用户体验改进

1. **一键撤销**：撤销所有更改按钮现在只需点击一次
2. **智能按钮状态**：按钮会根据实际的编辑状态智能启用/禁用
3. **实时状态反馈**：状态指示器（黄点）会立即反映文件的修改状态
4. **一致的行为**：所有相关组件的状态显示保持同步

这些修复确保了撤销/重做功能的可靠性和用户体验的一致性。